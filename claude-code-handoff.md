# Claude Code 작업 요청서

## 프로젝트 상황
- 기존 코드: swim-trainer (Next.js + MediaPipe + KNN)
- 레퍼런스 문서: `swim-trainer-reference.md` 참고
- 지금까지 작업 내용: 6대 생존수영 동작 정의, KNN 학습/연습 기능, 관리자 페이지

---

# 작업 1: 규칙 기반 자세 피드백 시스템

## 목표
KNN 학습 데이터 없이, 카메라만 켜면 바로 자세 피드백을 제공하는 시스템.
기존 KNN 학습/연습 구조는 유지하되, **별도 피드백 레이어**를 추가한다.

## 왜 규칙 기반인가
- 교육 대상이 학생이라 "먼저 정답을 녹화하세요"는 비현실적
- 카메라 켜고 바로 "팔을 더 올리세요" 같은 피드백이 나와야 함
- MediaPipe 랜드마크 좌표에서 관절 각도/거리를 직접 계산하여 판정

## 현재 features.js 구조 (활용 가능)
`extractFeatures(landmarks)` → 114차원 벡터:
- 99차원: 33개 랜드마크의 정규화 좌표 (엉덩이 중심, 어깨 너비 스케일)
- 8차원: 관절 각도 (0~1로 정규화, /180)
  - [0] ang(23,11,13) = 왼쪽 어깨 각도 (엉덩이-어깨-팔꿈치)
  - [1] ang(24,12,14) = 오른쪽 어깨 각도
  - [2] ang(11,13,15) = 왼쪽 팔꿈치 각도 (어깨-팔꿈치-손목)
  - [3] ang(12,14,16) = 오른쪽 팔꿈치 각도
  - [4] ang(13,11,23) = 왼쪽 어깨-엉덩이 각도
  - [5] ang(14,12,24) = 오른쪽 어깨-엉덩이 각도
  - [6] ang(11,23,25) = 왼쪽 엉덩이-무릎 각도 (어깨-엉덩이-무릎)
  - [7] ang(12,24,26) = 오른쪽 엉덩이-무릎 각도
- 6차원: 핵심 거리 (어깨 너비 기준 정규화)
  - [0] dist(15,16) = 양 손목 간 거리
  - [1] dist(15,23) = 왼손목-왼엉덩이 거리
  - [2] dist(16,24) = 오른손목-오른엉덩이 거리
  - [3] dist(15,0) = 왼손목-코 거리
  - [4] dist(16,0) = 오른손목-코 거리
  - [5] dist(0,23) = 코-왼엉덩이 거리 (상체 길이 참고)
- 1차원: 상체 기울기 (0=직립, 1=수평)

### MediaPipe 랜드마크 인덱스 참고
```
0: 코(nose)
11: 왼어깨  12: 오른어깨
13: 왼팔꿈치  14: 오른팔꿈치
15: 왼손목  16: 오른손목
23: 왼엉덩이  24: 오른엉덩이
25: 왼무릎  26: 오른무릎
27: 왼발목  28: 오른발목
```

## 6대 동작별 규칙 정의

피드백 판정용 새 파일 `lib/feedback.js` 생성을 권장한다.
landmarks (33개 raw 좌표)를 입력받아 각 동작별로 체크포인트를 검사하고,
통과/미통과 + 피드백 메시지를 반환한다.

### 동작 1: HELP 자세 (앉아서)
실제: 팔짱 끼고 무릎을 가슴으로 끌어올려 체온 보존
```
체크포인트:
1. 팔 교차: 양 손목 간 거리 < 어깨너비 * 0.4 AND 양 손목 y좌표가 어깨~가슴 높이
   - 실패 피드백: "양 팔을 가슴 앞에서 교차하세요"
2. 팔꿈치 각도: 양쪽 < 90° (팔을 접은 상태)
   - 실패 피드백: "팔을 더 접어 가슴에 밀착하세요"
3. 무릎 올리기: 무릎 y좌표 < 엉덩이 y좌표 (위로 올라감, y는 위가 작음)
   - 실패 피드백: "무릎을 가슴 쪽으로 끌어올리세요"
4. 완성: 위 3개 모두 통과 → "완벽한 HELP 자세입니다! 유지하세요"
```

### 동작 2: 새우등뜨기 (서서)
실제: 상체 숙이고 무릎 감싸기
```
체크포인트:
1. 상체 기울기: 어깨중심-엉덩이중심 기울기 > 30° (앞으로 숙임)
   - 실패 피드백: "상체를 앞으로 더 숙이세요"
2. 머리 숙이기: 코 y좌표 > 어깨 y좌표 (아래로 내려감)
   - 실패 피드백: "머리를 아래로 숙이세요"
3. 손-무릎 근접: 양 손목이 무릎 근처 (거리 < 어깨너비 * 0.6)
   - 실패 피드백: "양손으로 무릎을 감싸세요"
4. 완성: "새우등뜨기 자세 완성! 유지하세요"
```

### 동작 3: 구조 신호 (앉아서/서서)
실제: 한 팔만 머리 위로 올려서 좌우로 흔들기
```
체크포인트:
1. 한 팔 올리기: 한쪽 손목 y좌표 < 코 y좌표 (머리 위)
   - 실패 피드백: "한쪽 팔을 머리 위로 높이 올리세요"
2. 다른 팔 내리기: 반대쪽 손목 y좌표 > 어깨 y좌표 (아래에 유지)
   - 실패 피드백: "반대쪽 팔은 내리세요 (한 팔만 올립니다)"
3. 좌우 흔들기: 올린 손목의 x좌표 변화량 추적 (최근 10프레임)
   - 실패 피드백: "올린 팔을 좌우로 크게 흔드세요"
4. 완성: "좋습니다! 크게 흔들어 구조 신호를 보내세요"
```

### 동작 4: 스컬링 (앉아서)
실제: 양팔을 허리~가슴 높이에서 좌우로 벌렸다 모으기
```
체크포인트:
1. 팔 높이: 양 손목이 어깨~엉덩이 사이 높이
   - 실패 피드백: "팔을 허리~가슴 높이로 유지하세요"
2. 좌우 움직임: 양 손목 간 거리의 변화 추적 (벌리기↔모으기)
   - 실패 피드백: "팔을 좌우로 벌렸다 모았다 반복하세요"
3. 대칭성: 양 손목의 y좌표 차이 < 임계값
   - 실패 피드백: "양 팔 높이를 맞추세요"
4. 완성: "좋은 스컬링 동작입니다! 리듬을 유지하세요"
```

### 동작 5: 개헤엄 (앉아서)
실제: 양팔을 교대로 앞으로 뻗고 아래로 당기기
```
체크포인트:
1. 팔 교대: 양 손목 y좌표 차이 > 임계값 (하나는 위, 하나는 아래)
   - 실패 피드백: "양 팔을 교대로 위아래 움직이세요"
2. 뻗기 동작: 위쪽 손목이 어깨보다 위
   - 실패 피드백: "팔을 더 높이 뻗으세요"
3. 당기기 동작: 아래쪽 손목이 엉덩이 근처
   - 실패 피드백: "물을 밀어내듯 아래로 당기세요"
4. 완성: "개헤엄 동작이 좋습니다! 교대로 반복하세요"
```

### 동작 6: 누워뜨기 팔동작 (서서)
실제: 양팔을 어깨 높이로 옆으로 벌리기 (T자/대자)
```
체크포인트:
1. 팔 벌리기: 양 손목 간 거리 > 어깨너비 * 2.5
   - 실패 피드백: "양 팔을 옆으로 더 벌리세요"
2. 팔 높이: 양 손목 y좌표 ≈ 어깨 y좌표 (어깨 높이)
   - 실패 피드백: "팔을 어깨 높이로 맞추세요"
3. 팔꿈치 펴기: 양쪽 팔꿈치 각도 > 150° (거의 편 상태)
   - 실패 피드백: "팔꿈치를 펴세요"
4. 완성: "대자 자세 완성! 유지하세요"
```

## 구현 방향

### 새 파일: lib/feedback.js
```javascript
// 기본 구조 예시
export function evaluatePose(motionId, landmarks, history) {
  // landmarks: MediaPipe raw 33개 좌표
  // history: 최근 N프레임의 랜드마크 (흔들기 등 동적 판정용)
  // 반환: { checks: [{name, passed, message}], overallScore, summaryMessage }
}
```

### 연습 모드 연동
- 기존 KNN 인식과 **병렬**로 동작
- KNN은 "어떤 동작인지" 분류
- feedback.js는 "그 동작을 얼마나 정확히 하고 있는지" 판정
- UI에 체크리스트 형태로 표시 (✅ 팔 교차 / ❌ 무릎 올리기 → "무릎을 더 올리세요")

### 독립 모드 (학습 없이 바로 사용)
- KNN 학습 없이도 동작을 선택하면 바로 피드백만 제공하는 모드
- 동작 선택 → 카메라 ON → 규칙 기반 체크포인트 실시간 표시
- 모든 체크포인트 통과 시 타이머/카운트 시작

---

# 작업 2: 앱 리디자인

## 목표
현재 데스크탑 위주 레이아웃을 모바일 앱처럼 리디자인한다.
세로(portrait) 고정, 정보 제공 탭 추가, 네이티브 앱 느낌.

## 화면 비율
- **9:16 세로 고정** (모바일 기본)
- 데스크탑에서는 가운데 `max-width: 430px` 프레임으로 제한 (아이폰 15 Pro 기준)
- 양옆 여백은 어두운 배경으로 채움
- `<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">`
- PWA manifest 추가하면 홈 화면에 앱처럼 설치 가능 (선택사항)

## 네비게이션: 하단 탭 바 (5탭)

```
┌─────────────────────────────────┐
│                                 │
│         (콘텐츠 영역)            │
│                                 │
├─────────────────────────────────┤
│  🏠    📖    🏊    📊    ⚙     │
│  홈    학습   연습   기록   설정  │
└─────────────────────────────────┘
```

### 탭 1: 홈 🏠
- 앱 소개, 오늘의 연습 요약
- 6대 동작 카드 리스트 (각 동작의 연습 현황 표시)
- 빠른 시작 버튼 → 연습 탭으로 이동

### 탭 2: 학습 📖
참고 사이트(sunkikj.wixsite.com/swimmingforsurvival)의 구조를 참고한 정보 제공 섹션.

카테고리 구성:
```
학습
├── 생존수영이란
│   └── 생존수영의 정의, 필요성, 교육 과정 소개
├── 생존뜨기
│   ├── HELP 자세 (체온보존)
│   ├── 새우등뜨기 (Jellyfish Float)
│   ├── 누워뜨기 (Back Float)
│   └── 잎새뜨기 (참고)
├── 생존수영 영법
│   ├── 개헤엄 (Dog Paddle)
│   ├── 스컬링/입영 (Sculling)
│   └── 구조 신호 (Signal for Help)
├── 수상안전
│   ├── 물놀이 안전수칙
│   ├── 상황별 대처방법
│   └── 구명조끼 사용법
└── 응급처치
    ├── 심폐소생술
    └── 체온유지
```

각 항목의 내용 구성:
- 동작 설명 텍스트
- 핵심 포인트 (체크리스트)
- 참고 이미지 또는 일러스트 (저작권 자유 소스 또는 자체 제작)
- "연습하기" 버튼 → 연습 탭의 해당 동작으로 이동
- 참고 영상 링크 (안전한TV, EBS 등 외부 링크)

### 탭 3: 연습 🏊
현재 트레이너의 핵심 기능.

```
연습 탭 화면 구성 (세로 기준):

┌─────────────────────┐
│    [동작 선택 헤더]    │  ← 동작 이름 + 드롭다운 또는 좌우 스와이프
├─────────────────────┤
│                     │
│                     │
│   [카메라 뷰]        │  ← 화면의 약 55~60%
│   + 스켈레톤 오버레이  │
│   + 피드백 오버레이    │
│                     │
├─────────────────────┤
│  ✅ 팔 교차          │  ← 체크포인트 실시간 표시
│  ❌ 무릎 올리기       │     (규칙 기반 피드백)
│  ⏱ 12초 / 30초      │     + 타이머/카운트
├─────────────────────┤
│  [시작] [리셋] [녹화]  │  ← 액션 버튼
└─────────────────────┘
```

모드 전환:
- **즉시 연습**: 학습 데이터 없이 규칙 기반 피드백만 (기본)
- **KNN 연습**: 학습 데이터가 있으면 KNN 분류 + 규칙 피드백 병행
- **녹화 모드**: 교사/관리자용 학습 데이터 수집

### 탭 4: 기록 📊
- 연습 히스토리 (날짜, 동작, 점수)
- 동작별 달성 현황 (몇 번 성공했는지)
- 간단한 통계 차트
- localStorage 기반이므로 브라우저별

### 탭 5: 설정 ⚙
- 기존 관리자 페이지 기능 통합 (데이터 내보내기/가져오기/삭제)
- 카메라 설정 (전면/후면 전환)
- 유지시간 기본값 설정
- 앱 정보

## 연습 탭 카메라 영역 상세

세로 화면에서의 카메라 배치:
```
전체 높이: 100vh (탭바 56px 제외)
카메라 영역: 약 55~60% (탭바 위쪽 기준)
피드백 영역: 약 25~30%
컨트롤 영역: 약 10~15%
```

카메라 위 오버레이:
- 스켈레톤 (현재와 동일)
- 피드백 아이콘: 자세가 틀린 부위에 직접 표시 (예: 무릎 위치에 ↑ 화살표)
- 중앙 상단: 현재 동작 이름 + 상태 배지

## 색상/디자인 톤
- 현재 다크 테마 유지 (수영/바다 느낌)
- 주 색상: `#22d3ee` (시안), `#10b981` (성공 그린)
- 카드/섹션: `#1e293b` 배경 + `#334155` 테두리
- 둥근 모서리 (12~16px), 그림자 최소화
- 큰 터치 타겟 (최소 44px)

## 콘텐츠 소스 참고
- https://sunkikj.wixsite.com/swimmingforsurvival (동작 설명, 카테고리 구조)
- https://www.safetv.go.kr (교육 영상 링크)
- https://primary.ebs.co.kr/course/view?courseId=10201320 (EBS 강좌)
- https://news.hidoc.co.kr/news/articleView.html?idxno=19358 (동작 텍스트 설명)

---

# 우선순위

1. **규칙 기반 피드백 시스템** (lib/feedback.js) — 핵심 가치
2. **하단 탭 네비게이션 + 모바일 레이아웃** — 앱 느낌의 기초
3. **연습 탭 리디자인** (카메라 + 피드백 체크리스트)
4. **학습 탭** (정보 콘텐츠)
5. **기록 탭** (연습 히스토리)
6. **설정 탭** (기존 관리자 통합)

각 단계를 독립적으로 커밋 가능하게 진행하는 것을 권장한다.
